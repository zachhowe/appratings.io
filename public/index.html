<!DOCTYPE html>
<html>
<head>
    <meta name="robots" content="noindex">
    
    <title>App Ratings</title>

    <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen" />

    <script type="text/javascript" src="/js/chart.min.js"></script>
    <script type="text/javascript" src="/js/jquery-2.0.0.min.js"></script>

    <script type="text/javascript">
        window.onload = function() {
            $.get('/list', function(resp) {
                var status = resp.status;
                if (status !== 'ok') {
                    alert(status);
                } else {
                    var results = resp.results;
                    for (var i in results) {
                        var app = results[i];
                        $("#app_id").append('<option value="' + app.app_id + '">' + app.app_name + '</option>');
                    } 
                }
            });
        }
    
        function renderLineChart(data) {
            var ctx = $("#linechart").get(0).getContext("2d");

            var myNewChart = new Chart(ctx);
            myNewChart.Line(data, null);
        }

        function loadApp() {
            var app_id = $('#app_id').val();
            
            loadLineGraph(app_id);
        }
    
        function loadLineGraph(app_id) {
            $.get('/ratings/' + app_id, function(read_data) {
                var status = read_data.status;
                var results = read_data.results;
                var info = results.info;
                $('#app_name').text(info.app_name);
                $('#app_version').text('Version: ' + info.app_version);

                var records = results.records;
                var plot_data_total = Array();
                var plot_data_verion = Array();
                var labels = Array();

                if (records.length > 1) {
                    for (var i in records) {
                        var r = records[i];
                        
                        plot_data_total.push(r.ratings_total_avg);
                        plot_data_verion.push(r.ratings_version_avg);
                        labels.push(r.chart_label);
                    }

                    var data = {
                        labels : labels,
                        datasets : [
                            // {
                            //     fillColor : "rgba(220,220,220,0.5)",
                            //     strokeColor : "rgba(220,220,220,1)",
                            //     pointColor : "rgba(220,220,220,1)",
                            //     pointStrokeColor : "#fff",
                            //     data : plot_data_total
                            // },
                            {
                                fillColor : "rgba(151,187,205,0.5)",
                                strokeColor : "rgba(151,187,205,1)",
                                pointColor : "rgba(151,187,205,1)",
                                pointStrokeColor : "#fff",
                                data : plot_data_verion
                            }
                        ]
                    };

                    renderLineChart(data);
                } else {
                    alert('Sorry, there is not enough ratings to show yet. Need at least two days of data to show.');
                }
            });
        }
    </script>
</head>
<body>
    <div id="wrapper">
        <div id="header">
            <h1 id="site_name">App Ratings</h1>
            <h2 id="app_name"></h1>
            <h3 id="app_version"></h2>
            Select an App: <select id="app_id"></select><br/><br/><button onclick="loadApp();">Load App</button>
        </div>

        <div id="chart-wrapper">
            <canvas width="700" height="300" id="linechart"></canvas>
        </div>

        <div id="footer">
            <p>Site Developed by: <a href="http://zach.la">Zach Howe</a></p>
            <p>Made with <a href="http://www.sinatrarb.com">Sinatra</a>, <a href="http://www.mongodb.org">MongoDB</a>, <a href="http://www.chartjs.org">Chart.js</a>, <a href="https://github.com/zachhowe/appratings">App Ratings Ruby Gem</a></p>
            <p><a href="/admin">Admin Panel</a></p>
        </div>
    </div>
</body>
</html>
