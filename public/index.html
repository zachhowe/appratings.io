<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen" />

    <script type="text/javascript" src="/js/jquery-2.0.0.min.js"></script>
    <script type="text/javascript" src="/js/chart.min.js"></script>

    <title>App Ratings</title>

    <script type="text/javascript">
        window.onload = function() {
            $.get('/list', function(resp) {
                var status = resp.status;
                if (status !== 'ok') {
                    alert(status);
                } else {
                    var results = resp.results;
                    for (var i in results) {
                        var app = results[i];
                        $("#app_id").append('<option value="' + app.app_id + '">' + app.app_name + '</option>');
                    } 
                }
            });
        }
    
        function renderLineChart(data) {
            var ctx = $("#linechart").get(0).getContext("2d");

            var myNewChart = new Chart(ctx);
            myNewChart.Line(data, null);
        }

        function loadApp() {
            var app_id = $('#app_id').val();
            
            loadLineGraph(app_id);
        }
    
        function loadLineGraph(app_id) {
            $.get('/ratings/' + app_id, function(read_data) {
                var status = read_data.status;
                var results = read_data.results;
                var info = results.info;
                $('#app_name').text(info.app_name);
                $('#app_version').text('Version: ' + info.app_version);

                var records = results.records;
                var plot_data = Array();
                var labels = Array();

                if (records.length > 1) {
                    for (var i in records) {
                        var r = records[i];

                        plot_data.push(r.average);
                        labels.push(r.date);
                    }

                    var data = {
                        labels : labels,
                        datasets : [
                        {
                            fillColor : "rgba(220,220,220,0.5)",
                            strokeColor : "rgba(220,220,220,1)",
                            pointColor : "rgba(220,220,220,1)",
                            pointStrokeColor : "#fff",
                            data : plot_data
                        }
                    ]};

                    renderLineChart(data);
                } else {
                    alert('Sorry, not enough ratings to show.');
                }
            });
        }
    </script>
</head>
<body>
    <div id="wrapper">
        <div style="text-align: center;">
            <h1 id="site_name">App Ratings</h1>
        </div>
        
        <div style="text-align: center;">
            <h2 id="app_name"></h1>
            <h3 id="app_version"></h2>
        </div>

        <div style="text-align: center;">
            Select an App: <select id="app_id"></select><br/><br/><button onclick="loadApp();">Load App</button>
        </div>

        <div id="chart-wrapper">
            <canvas width="700" height="300" id="linechart"></canvas>
        </div>
    </div>
</body>
</html>
